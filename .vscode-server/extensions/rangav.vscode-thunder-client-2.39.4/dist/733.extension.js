"use strict";exports.id=733,exports.ids=[733],exports.modules={1303(e,t,r){r.d(t,{fromIni:()=>T});var n=r(1300),i=r(63),o=r(62),s=r(83),a=r(59);const c=e=>(0,s.g)(e,"CREDENTIALS_PROFILE_NAMED_PROVIDER","p"),l=(e,{profile:t,logger:r})=>{const n="string"==typeof e.source_profile&&void 0===e.credential_source;return n&&r?.debug?.(`    ${t} isAssumeRoleWithSourceProfile source_profile=${e.source_profile}`),n},f=(e,{profile:t,logger:r})=>{const n="string"==typeof e.credential_source&&void 0===e.source_profile;return n&&r?.debug?.(`    ${t} isCredentialSourceProfile credential_source=${e.credential_source}`),n},d=async(e,t,n,l,f={},d)=>{n.logger?.debug("@aws-sdk/credential-provider-ini - resolveAssumeRoleCredentials (STS)");const u=t[e],{source_profile:p,region:h}=u;if(!n.roleAssumer){const{getDefaultRoleAssumer:e}=await r.e(827).then(r.bind(r,1321));n.roleAssumer=e({...n.clientConfig,credentialProviderLogger:n.logger,parentClientConfig:{...l,...n?.parentClientConfig,region:h??n?.parentClientConfig?.region??l?.region}},n.clientPlugins)}if(p&&p in f)throw new o.C(`Detected a cycle attempting to resolve credentials for profile ${(0,i.Bz)(n)}. Profiles visited: `+Object.keys(f).join(", "),{logger:n.logger});n.logger?.debug("@aws-sdk/credential-provider-ini - finding credential resolver using "+(p?`source_profile=[${p}]`:`profile=[${e}]`));const y=p?d(p,t,n,l,{...f,[p]:!0},g(t[p]??{})):(await((e,t,n)=>{const i={EcsContainer:async e=>{const{fromHttp:t}=await r.e(963).then(r.bind(r,1309)),{fromContainerMetadata:i}=await r.e(330).then(r.bind(r,1308));return n?.debug("@aws-sdk/credential-provider-ini - credential_source is EcsContainer"),async()=>(0,a.c)(t(e??{}),i(e))().then(c)},Ec2InstanceMetadata:async e=>{n?.debug("@aws-sdk/credential-provider-ini - credential_source is Ec2InstanceMetadata");const{fromInstanceMetadata:t}=await r.e(330).then(r.bind(r,1308));return async()=>t(e)().then(c)},Environment:async e=>{n?.debug("@aws-sdk/credential-provider-ini - credential_source is Environment");const{fromEnv:t}=await r.e(960).then(r.bind(r,1322));return async()=>t(e)().then(c)}};if(e in i)return i[e];throw new o.C(`Unsupported credential source in profile ${t}. Got ${e}, expected EcsContainer or Ec2InstanceMetadata or Environment.`,{logger:n})})(u.credential_source,e,n.logger)(n))();if(g(u))return y.then(e=>(0,s.g)(e,"CREDENTIALS_PROFILE_SOURCE_PROFILE","o"));{const t={RoleArn:u.role_arn,RoleSessionName:u.role_session_name||`aws-sdk-js-${Date.now()}`,ExternalId:u.external_id,DurationSeconds:parseInt(u.duration_seconds||"3600",10)},{mfa_serial:r}=u;if(r){if(!n.mfaCodeProvider)throw new o.C(`Profile ${e} requires multi-factor authentication, but no MFA code callback was provided.`,{logger:n.logger,tryNextLink:!1});t.SerialNumber=r,t.TokenCode=await n.mfaCodeProvider(r)}const i=await y;return n.roleAssumer(i,t).then(e=>(0,s.g)(e,"CREDENTIALS_PROFILE_SOURCE_PROFILE","o"))}},g=e=>!e.role_arn&&!!e.credential_source;var u=r(37),p=r(70),h=r(24),y=r(107),w=r(21),E=r(1304);class I{profileData;init;callerClientConfig;static REFRESH_THRESHOLD=3e5;constructor(e,t,r){this.profileData=e,this.init=t,this.callerClientConfig=r}async loadCredentials(){const e=await this.loadToken();if(!e)throw new o.C(`Failed to load a token for session ${this.loginSession}, please re-authenticate using aws login`,{tryNextLink:!1,logger:this.logger});const t=e.accessToken,r=Date.now();return new Date(t.expiresAt).getTime()-r<=I.REFRESH_THRESHOLD?this.refresh(e):{accessKeyId:t.accessKeyId,secretAccessKey:t.secretAccessKey,sessionToken:t.sessionToken,accountId:t.accountId,expiration:new Date(t.expiresAt)}}get logger(){return this.init?.logger}get loginSession(){return this.profileData.login_session}async refresh(e){const{SigninClient:t,CreateOAuth2TokenCommand:n}=await Promise.all([r.e(372),r.e(780)]).then(r.bind(r,1323)),{logger:i,userAgentAppId:s}=this.callerClientConfig??{},a=(e=>"h2"===e?.metadata?.handlerProtocol)(this.callerClientConfig?.requestHandler)?void 0:this.callerClientConfig?.requestHandler,c=new t({credentials:{accessKeyId:"",secretAccessKey:""},region:this.profileData.region??await(this.callerClientConfig?.region?.())??process.env.AWS_REGION,requestHandler:a,logger:i,userAgentAppId:s,...this.init?.clientConfig});this.createDPoPInterceptor(c.middlewareStack);const l={tokenInput:{clientId:e.clientId,refreshToken:e.refreshToken,grantType:"refresh_token"}};try{const t=await c.send(new n(l)),{accessKeyId:r,secretAccessKey:i,sessionToken:s}=t.tokenOutput?.accessToken??{},{refreshToken:a,expiresIn:f}=t.tokenOutput??{};if(!(r&&i&&s&&a))throw new o.C("Token refresh response missing required fields",{logger:this.logger,tryNextLink:!1});const d=1e3*(f??900),g=new Date(Date.now()+d),u={...e,accessToken:{...e.accessToken,accessKeyId:r,secretAccessKey:i,sessionToken:s,expiresAt:g.toISOString()},refreshToken:a};await this.saveToken(u);const p=u.accessToken;return{accessKeyId:p.accessKeyId,secretAccessKey:p.secretAccessKey,sessionToken:p.sessionToken,accountId:p.accountId,expiration:g}}catch(e){if("AccessDeniedException"===e.name){let t;switch(e.error){case"TOKEN_EXPIRED":t="Your session has expired. Please reauthenticate.";break;case"USER_CREDENTIALS_CHANGED":t="Unable to refresh credentials because of a change in your password. Please reauthenticate with your new password.";break;case"INSUFFICIENT_PERMISSIONS":t="Unable to refresh credentials due to insufficient permissions. You may be missing permission for the 'CreateOAuth2Token' action.";break;default:t=`Failed to refresh token: ${String(e)}. Please re-authenticate using \`aws login\``}throw new o.C(t,{logger:this.logger,tryNextLink:!1})}throw new o.C(`Failed to refresh token: ${String(e)}. Please re-authenticate using aws login`,{logger:this.logger})}}async loadToken(){const e=this.getTokenFilePath();try{let t;try{t=await(0,p.TA)(e,{ignoreCache:this.init?.ignoreCache})}catch{t=await y.promises.readFile(e,"utf8")}const r=JSON.parse(t),n=["accessToken","clientId","refreshToken","dpopKey"].filter(e=>!r[e]);if(r.accessToken?.accountId||n.push("accountId"),n.length>0)throw new o.C(`Token validation failed, missing fields: ${n.join(", ")}`,{logger:this.logger,tryNextLink:!1});return r}catch(t){throw new o.C(`Failed to load token from ${e}: ${String(t)}`,{logger:this.logger,tryNextLink:!1})}}async saveToken(e){const t=this.getTokenFilePath(),r=(0,E.dirname)(t);try{await y.promises.mkdir(r,{recursive:!0})}catch(e){}await y.promises.writeFile(t,JSON.stringify(e,null,2),"utf8")}getTokenFilePath(){const e=process.env.AWS_LOGIN_CACHE_DIRECTORY??(0,E.join)((0,w.homedir)(),".aws","login","cache"),t=Buffer.from(this.loginSession,"utf8"),r=(0,h.createHash)("sha256").update(t).digest("hex");return(0,E.join)(e,`${r}.json`)}derToRawSignature(e){let t=2;if(2!==e[t])throw new Error("Invalid DER signature");t++;const r=e[t++];let n=e.subarray(t,t+r);if(t+=r,2!==e[t])throw new Error("Invalid DER signature");t++;const i=e[t++];let o=e.subarray(t,t+i);n=0===n[0]?n.subarray(1):n,o=0===o[0]?o.subarray(1):o;const s=Buffer.concat([Buffer.alloc(32-n.length),n]),a=Buffer.concat([Buffer.alloc(32-o.length),o]);return Buffer.concat([s,a])}createDPoPInterceptor(e){e.add(e=>async t=>{if(u.K.isInstance(t.request)){const e=t.request,r=`${e.protocol}//${e.hostname}${e.port?`:${e.port}`:""}${e.path}`,n=await this.generateDpop(e.method,r);e.headers={...e.headers,DPoP:n}}return e(t)},{step:"finalizeRequest",name:"dpopInterceptor",override:!0})}async generateDpop(e="POST",t){const r=await this.loadToken();try{const n=(0,h.createPrivateKey)({key:r.dpopKey,format:"pem",type:"sec1"}),i=(0,h.createPublicKey)(n).export({format:"der",type:"spki"});let o=-1;for(let e=0;e<i.length;e++)if(4===i[e]){o=e;break}const s=i.slice(o+1,o+33),a=i.slice(o+33,o+65),c={alg:"ES256",typ:"dpop+jwt",jwk:{kty:"EC",crv:"P-256",x:s.toString("base64url"),y:a.toString("base64url")}},l={jti:crypto.randomUUID(),htm:e,htu:t,iat:Math.floor(Date.now()/1e3)},f=Buffer.from(JSON.stringify(c)).toString("base64url"),d=`${f}.${Buffer.from(JSON.stringify(l)).toString("base64url")}`,g=(0,h.sign)("sha256",Buffer.from(d),n),u=this.derToRawSignature(g);return`${d}.${u.toString("base64url")}`}catch(e){throw new o.C(`Failed to generate Dpop proof: ${e instanceof Error?e.message:String(e)}`,{logger:this.logger,tryNextLink:!1})}}}const C=async(e,t,r)=>{const a=await(c={...t,profile:e},async({callerClientConfig:e}={})=>{c?.logger?.debug?.("@aws-sdk/credential-providers - fromLoginCredentials");const t=await(0,n.Y)(c||{}),r=(0,i.Bz)({profile:c?.profile??e?.profile}),a=t[r];if(!a?.login_session)throw new o.C(`Profile ${r} does not contain login_session.`,{tryNextLink:!0,logger:c?.logger});const l=new I(a,c,e),f=await l.loadCredentials();return(0,s.g)(f,"CREDENTIALS_LOGIN","AD")})({callerClientConfig:r});var c;return(0,s.g)(a,"CREDENTIALS_PROFILE_LOGIN","AC")},k=e=>Boolean(e)&&"object"==typeof e&&"string"==typeof e.aws_access_key_id&&"string"==typeof e.aws_secret_access_key&&["undefined","string"].indexOf(typeof e.aws_session_token)>-1&&["undefined","string"].indexOf(typeof e.aws_account_id)>-1,S=async(e,t)=>{t?.logger?.debug("@aws-sdk/credential-provider-ini - resolveStaticCredentials");const r={accessKeyId:e.aws_access_key_id,secretAccessKey:e.aws_secret_access_key,sessionToken:e.aws_session_token,...e.aws_credential_scope&&{credentialScope:e.aws_credential_scope},...e.aws_account_id&&{accountId:e.aws_account_id}};return(0,s.g)(r,"CREDENTIALS_PROFILE","n")},R=async(e,t,n,i,a={},c=!1)=>{const g=t[e];if(Object.keys(a).length>0&&k(g))return S(g,n);if(c||((e,{profile:t="default",logger:r}={})=>Boolean(e)&&"object"==typeof e&&"string"==typeof e.role_arn&&["undefined","string"].indexOf(typeof e.role_session_name)>-1&&["undefined","string"].indexOf(typeof e.external_id)>-1&&["undefined","string"].indexOf(typeof e.mfa_serial)>-1&&(l(e,{profile:t,logger:r})||f(e,{profile:t,logger:r})))(g,{profile:e,logger:n.logger}))return d(e,t,n,i,a,R);if(k(g))return S(g,n);if(u=g,Boolean(u)&&"object"==typeof u&&"string"==typeof u.web_identity_token_file&&"string"==typeof u.role_arn&&["undefined","string"].indexOf(typeof u.role_session_name)>-1)return(async(e,t,n)=>r.e(522).then(r.bind(r,1307)).then(({fromTokenFile:r})=>r({webIdentityTokenFile:e.web_identity_token_file,roleArn:e.role_arn,roleSessionName:e.role_session_name,roleAssumerWithWebIdentity:t.roleAssumerWithWebIdentity,logger:t.logger,parentClientConfig:t.parentClientConfig})({callerClientConfig:n}).then(e=>(0,s.g)(e,"CREDENTIALS_PROFILE_STS_WEB_ID_TOKEN","q"))))(g,n,i);var u;if((e=>Boolean(e)&&"object"==typeof e&&"string"==typeof e.credential_process)(g))return(async(e,t)=>r.e(876).then(r.bind(r,1305)).then(({fromProcess:r})=>r({...e,profile:t})().then(e=>(0,s.g)(e,"CREDENTIALS_PROFILE_PROCESS","v"))))(n,e);if((e=>e&&("string"==typeof e.sso_start_url||"string"==typeof e.sso_account_id||"string"==typeof e.sso_session||"string"==typeof e.sso_region||"string"==typeof e.sso_role_name))(g))return await(async(e,t,n={},i)=>{const{fromSSO:o}=await r.e(593).then(r.bind(r,1299));return o({profile:e,logger:n.logger,parentClientConfig:n.parentClientConfig,clientConfig:n.clientConfig})({callerClientConfig:i}).then(e=>t.sso_session?(0,s.g)(e,"CREDENTIALS_PROFILE_SSO","r"):(0,s.g)(e,"CREDENTIALS_PROFILE_SSO_LEGACY","t"))})(e,g,n,i);if((e=>Boolean(e&&e.login_session))(g))return C(e,n,i);throw new o.C(`Could not resolve credentials using profile: [${e}] in configuration/credentials file(s).`,{logger:n.logger})},T=(e={})=>async({callerClientConfig:t}={})=>{e.logger?.debug("@aws-sdk/credential-provider-ini - fromIni");const r=await(0,n.Y)(e);return R((0,i.Bz)({profile:e.profile??t?.profile}),r,e,t)}},1300(e,t,r){r.d(t,{Y:()=>i});var n=r(64);const i=async e=>{const t=await(0,n.p)(e);return((...e)=>{const t={};for(const r of e)for(const[e,n]of Object.entries(r))void 0!==t[e]?Object.assign(t[e],n):t[e]=n;return t})(t.configFile,t.credentialsFile)}}};