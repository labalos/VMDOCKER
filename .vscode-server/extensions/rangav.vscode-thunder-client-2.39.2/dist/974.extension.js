"use strict";exports.id=974,exports.ids=[593,974],exports.modules={1300(e,o,s){s.d(o,{fromSSO:()=>N});var t=s(63),n=s(64),r=s(1301),i=s(68),a=s(66),c=s(67);const l=e=>Object.entries(e).filter(([e])=>e.startsWith(a.I.SSO_SESSION+c.Q)).reduce((e,[o,s])=>({...e,[o.substring(o.indexOf(c.Q)+1)]:s}),{});var f=s(70),g=s(71);const w=()=>({}),h=async(e={})=>(0,g.TA)(e.configFilepath??(0,i.g)()).then(f.A).then(l).catch(w);var d=s(84),p=s(61);class u extends p.m{name="TokenProviderError";constructor(e,o=!0){super(e,o),Object.setPrototypeOf(this,u.prototype)}}var S=s(1302);const C="To refresh this SSO session run 'aws sso login' with the corresponding profile.",y=async(e,o,t={},n)=>{const{CreateTokenCommand:r}=await Promise.all([s.e(372),s.e(224)]).then(s.bind(s,1319)),i=await(async(e,o={},t)=>{const{SSOOIDCClient:n}=await Promise.all([s.e(372),s.e(224)]).then(s.bind(s,1319)),r=e=>o.clientConfig?.[e]??o.parentClientConfig?.[e]??t?.[e];return new n(Object.assign({},o.clientConfig??{},{region:e??o.clientConfig?.region,logger:r("logger"),userAgentAppId:r("userAgentAppId")}))})(o,t,n);return i.send(new r({clientId:e.clientId,clientSecret:e.clientSecret,refreshToken:e.refreshToken,grantType:"refresh_token"}))},k=e=>{if(e.expiration&&e.expiration.getTime()<Date.now())throw new u(`Token is expired. ${C}`,!1)},m=(e,o,s=!1)=>{if(void 0===o)throw new u(`Value not present for '${e}' in SSO Token${s?". Cannot refresh":""}. ${C}`,!1)};var _=s(1303),O=s(10);const{writeFile:x}=O.promises,T=new Date(0),A=(e={})=>async({callerClientConfig:o}={})=>{e.logger?.debug("@aws-sdk/token-providers - fromSso");const s=await(0,r.Y)(e),t=(0,n.Bz)({profile:e.profile??o?.profile}),i=s[t];if(!i)throw new u(`Profile '${t}' could not be found in shared credentials file.`,!1);if(!i.sso_session)throw new u(`Profile '${t}' is missing required property 'sso_session'.`);const a=i.sso_session,c=(await h(e))[a];if(!c)throw new u(`Sso session '${a}' could not be found in shared credentials file.`,!1);for(const e of["sso_start_url","sso_region"])if(!c[e])throw new u(`Sso session '${a}' is missing required property '${e}'.`,!1);c.sso_start_url;const l=c.sso_region;let f;try{f=await(0,S.v)(a)}catch(e){throw new u(`The SSO session token associated with profile=${t} was not found or is invalid. ${C}`,!1)}m("accessToken",f.accessToken),m("expiresAt",f.expiresAt);const{accessToken:g,expiresAt:w}=f,d={token:g,expiration:new Date(w)};if(d.expiration.getTime()-Date.now()>3e5)return d;if(Date.now()-T.getTime()<3e4)return k(d),d;m("clientId",f.clientId,!0),m("clientSecret",f.clientSecret,!0),m("refreshToken",f.refreshToken,!0);try{T.setTime(Date.now());const s=await y(f,l,e,o);m("accessToken",s.accessToken),m("expiresIn",s.expiresIn);const t=new Date(Date.now()+1e3*s.expiresIn);try{await((e,o)=>{const s=(0,_.C)(e),t=JSON.stringify(o,null,2);return x(s,t)})(a,{...f,accessToken:s.accessToken,expiresAt:t.toISOString(),refreshToken:s.refreshToken})}catch(e){}return{token:s.accessToken,expiration:t}}catch(e){return k(d),d}},I=!1,v=async({ssoStartUrl:e,ssoSession:o,ssoAccountId:n,ssoRegion:r,ssoRoleName:i,ssoClient:a,clientConfig:c,parentClientConfig:l,callerClientConfig:f,profile:g,filepath:w,configFilepath:h,ignoreCache:p,logger:u})=>{let C;const y="To refresh this SSO session run aws sso login with the corresponding profile.";if(o)try{const e=await A({profile:g,filepath:w,configFilepath:h,ignoreCache:p})();C={accessToken:e.token,expiresAt:new Date(e.expiration).toISOString()}}catch(e){throw new t.C(e.message,{tryNextLink:I,logger:u})}else try{C=await(0,S.v)(e)}catch(e){throw new t.C(`The SSO session associated with this profile is invalid. ${y}`,{tryNextLink:I,logger:u})}if(new Date(C.expiresAt).getTime()-Date.now()<=0)throw new t.C(`The SSO session associated with this profile has expired. ${y}`,{tryNextLink:I,logger:u});const{accessToken:k}=C,{SSOClient:m,GetRoleCredentialsCommand:_}=await Promise.all([s.e(372),s.e(896)]).then(s.bind(s,1313)),O=a||new m(Object.assign({},c??{},{logger:c?.logger??f?.logger??l?.logger,region:c?.region??r,userAgentAppId:c?.userAgentAppId??f?.userAgentAppId??l?.userAgentAppId}));let x;try{x=await O.send(new _({accountId:n,roleName:i,accessToken:k}))}catch(e){throw new t.C(e,{tryNextLink:I,logger:u})}const{roleCredentials:{accessKeyId:T,secretAccessKey:v,sessionToken:N,expiration:$,credentialScope:D,accountId:R}={}}=x;if(!(T&&v&&N&&$))throw new t.C("SSO returns an invalid temporary credential.",{tryNextLink:I,logger:u});const L={accessKeyId:T,secretAccessKey:v,sessionToken:N,expiration:new Date($),...D&&{credentialScope:D},...R&&{accountId:R}};return o?(0,d.g)(L,"CREDENTIALS_SSO","s"):(0,d.g)(L,"CREDENTIALS_SSO_LEGACY","u"),L},N=(e={})=>async({callerClientConfig:o}={})=>{e.logger?.debug("@aws-sdk/credential-provider-sso - fromSSO");const{ssoStartUrl:s,ssoAccountId:i,ssoRegion:a,ssoRoleName:c,ssoSession:l}=e,{ssoClient:f}=e,g=(0,n.Bz)({profile:e.profile??o?.profile});if(s||i||a||c||l){if(s&&i&&a&&c)return v({ssoStartUrl:s,ssoSession:l,ssoAccountId:i,ssoRegion:a,ssoRoleName:c,ssoClient:f,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,callerClientConfig:e.callerClientConfig,profile:g,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger});throw new t.C('Incomplete configuration. The fromSSO() argument hash must include "ssoStartUrl", "ssoAccountId", "ssoRegion", "ssoRoleName"',{tryNextLink:!1,logger:e.logger})}{const o=(await(0,r.Y)(e))[g];if(!o)throw new t.C(`Profile ${g} was not found.`,{logger:e.logger});if(!(w=o)||"string"!=typeof w.sso_start_url&&"string"!=typeof w.sso_account_id&&"string"!=typeof w.sso_session&&"string"!=typeof w.sso_region&&"string"!=typeof w.sso_role_name)throw new t.C(`Profile ${g} is not configured with SSO credentials.`,{logger:e.logger});if(o?.sso_session){const n=(await h(e))[o.sso_session],r=` configurations in profile ${g} and sso-session ${o.sso_session}`;if(a&&a!==n.sso_region)throw new t.C("Conflicting SSO region"+r,{tryNextLink:!1,logger:e.logger});if(s&&s!==n.sso_start_url)throw new t.C("Conflicting SSO start_url"+r,{tryNextLink:!1,logger:e.logger});o.sso_region=n.sso_region,o.sso_start_url=n.sso_start_url}const{sso_start_url:n,sso_account_id:i,sso_region:c,sso_role_name:l,sso_session:d}=((e,o)=>{const{sso_start_url:s,sso_account_id:n,sso_region:r,sso_role_name:i}=e;if(!(s&&n&&r&&i))throw new t.C(`Profile is configured with invalid SSO credentials. Required parameters "sso_account_id", "sso_region", "sso_role_name", "sso_start_url". Got ${Object.keys(e).join(", ")}\nReference: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html`,{tryNextLink:!1,logger:o});return e})(o,e.logger);return v({ssoStartUrl:n,ssoSession:d,ssoAccountId:i,ssoRegion:c,ssoRoleName:l,ssoClient:f,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,callerClientConfig:e.callerClientConfig,profile:g,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger})}var w}},1303(e,o,s){s.d(o,{C:()=>i});var t=s(9),n=s(5),r=s(69);const i=e=>{const o=(0,t.createHash)("sha1").update(e).digest("hex");return(0,n.join)((0,r.R)(),".aws","sso","cache",`${o}.json`)}},1302(e,o,s){s.d(o,{a:()=>r,v:()=>i});var t=s(31),n=s(1303);const r={},i=async e=>{if(r[e])return r[e];const o=(0,n.C)(e),s=await(0,t.readFile)(o,"utf8");return JSON.parse(s)}},1301(e,o,s){s.d(o,{Y:()=>n});var t=s(65);const n=async e=>{const o=await(0,t.p)(e);return((...e)=>{const o={};for(const s of e)for(const[e,t]of Object.entries(s))void 0!==o[e]?Object.assign(o[e],t):o[e]=t;return o})(o.configFile,o.credentialsFile)}}};