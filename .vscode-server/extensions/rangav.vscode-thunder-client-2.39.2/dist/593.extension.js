"use strict";exports.id=593,exports.ids=[593],exports.modules={1300(e,s,o){o.d(s,{fromSSO:()=>$});var t=o(63),n=o(64),r=o(1301),i=o(68),a=o(66),c=o(67);const l=e=>Object.entries(e).filter(([e])=>e.startsWith(a.I.SSO_SESSION+c.Q)).reduce((e,[s,o])=>({...e,[s.substring(s.indexOf(c.Q)+1)]:o}),{});var f=o(70),g=o(71);const w=()=>({}),h=async(e={})=>(0,g.TA)(e.configFilepath??(0,i.g)()).then(f.A).then(l).catch(w);var d=o(84),p=o(61);class u extends p.m{name="TokenProviderError";constructor(e,s=!0){super(e,s),Object.setPrototypeOf(this,u.prototype)}}var S=o(1302);const C="To refresh this SSO session run 'aws sso login' with the corresponding profile.",y=async(e,s,t={},n)=>{const{CreateTokenCommand:r}=await Promise.all([o.e(372),o.e(224)]).then(o.bind(o,1319)),i=await(async(e,s={},t)=>{const{SSOOIDCClient:n}=await Promise.all([o.e(372),o.e(224)]).then(o.bind(o,1319)),r=e=>s.clientConfig?.[e]??s.parentClientConfig?.[e]??t?.[e];return new n(Object.assign({},s.clientConfig??{},{region:e??s.clientConfig?.region,logger:r("logger"),userAgentAppId:r("userAgentAppId")}))})(s,t,n);return i.send(new r({clientId:e.clientId,clientSecret:e.clientSecret,refreshToken:e.refreshToken,grantType:"refresh_token"}))},k=e=>{if(e.expiration&&e.expiration.getTime()<Date.now())throw new u(`Token is expired. ${C}`,!1)},m=(e,s,o=!1)=>{if(void 0===s)throw new u(`Value not present for '${e}' in SSO Token${o?". Cannot refresh":""}. ${C}`,!1)};var _=o(1303),O=o(10);const{writeFile:x}=O.promises,T=new Date(0),A=(e={})=>async({callerClientConfig:s}={})=>{e.logger?.debug("@aws-sdk/token-providers - fromSso");const o=await(0,r.Y)(e),t=(0,n.Bz)({profile:e.profile??s?.profile}),i=o[t];if(!i)throw new u(`Profile '${t}' could not be found in shared credentials file.`,!1);if(!i.sso_session)throw new u(`Profile '${t}' is missing required property 'sso_session'.`);const a=i.sso_session,c=(await h(e))[a];if(!c)throw new u(`Sso session '${a}' could not be found in shared credentials file.`,!1);for(const e of["sso_start_url","sso_region"])if(!c[e])throw new u(`Sso session '${a}' is missing required property '${e}'.`,!1);c.sso_start_url;const l=c.sso_region;let f;try{f=await(0,S.v)(a)}catch(e){throw new u(`The SSO session token associated with profile=${t} was not found or is invalid. ${C}`,!1)}m("accessToken",f.accessToken),m("expiresAt",f.expiresAt);const{accessToken:g,expiresAt:w}=f,d={token:g,expiration:new Date(w)};if(d.expiration.getTime()-Date.now()>3e5)return d;if(Date.now()-T.getTime()<3e4)return k(d),d;m("clientId",f.clientId,!0),m("clientSecret",f.clientSecret,!0),m("refreshToken",f.refreshToken,!0);try{T.setTime(Date.now());const o=await y(f,l,e,s);m("accessToken",o.accessToken),m("expiresIn",o.expiresIn);const t=new Date(Date.now()+1e3*o.expiresIn);try{await((e,s)=>{const o=(0,_.C)(e),t=JSON.stringify(s,null,2);return x(o,t)})(a,{...f,accessToken:o.accessToken,expiresAt:t.toISOString(),refreshToken:o.refreshToken})}catch(e){}return{token:o.accessToken,expiration:t}}catch(e){return k(d),d}},I=!1,N=async({ssoStartUrl:e,ssoSession:s,ssoAccountId:n,ssoRegion:r,ssoRoleName:i,ssoClient:a,clientConfig:c,parentClientConfig:l,callerClientConfig:f,profile:g,filepath:w,configFilepath:h,ignoreCache:p,logger:u})=>{let C;const y="To refresh this SSO session run aws sso login with the corresponding profile.";if(s)try{const e=await A({profile:g,filepath:w,configFilepath:h,ignoreCache:p})();C={accessToken:e.token,expiresAt:new Date(e.expiration).toISOString()}}catch(e){throw new t.C(e.message,{tryNextLink:I,logger:u})}else try{C=await(0,S.v)(e)}catch(e){throw new t.C(`The SSO session associated with this profile is invalid. ${y}`,{tryNextLink:I,logger:u})}if(new Date(C.expiresAt).getTime()-Date.now()<=0)throw new t.C(`The SSO session associated with this profile has expired. ${y}`,{tryNextLink:I,logger:u});const{accessToken:k}=C,{SSOClient:m,GetRoleCredentialsCommand:_}=await Promise.all([o.e(372),o.e(896)]).then(o.bind(o,1313)),O=a||new m(Object.assign({},c??{},{logger:c?.logger??f?.logger??l?.logger,region:c?.region??r,userAgentAppId:c?.userAgentAppId??f?.userAgentAppId??l?.userAgentAppId}));let x;try{x=await O.send(new _({accountId:n,roleName:i,accessToken:k}))}catch(e){throw new t.C(e,{tryNextLink:I,logger:u})}const{roleCredentials:{accessKeyId:T,secretAccessKey:N,sessionToken:$,expiration:v,credentialScope:D,accountId:R}={}}=x;if(!(T&&N&&$&&v))throw new t.C("SSO returns an invalid temporary credential.",{tryNextLink:I,logger:u});const L={accessKeyId:T,secretAccessKey:N,sessionToken:$,expiration:new Date(v),...D&&{credentialScope:D},...R&&{accountId:R}};return s?(0,d.g)(L,"CREDENTIALS_SSO","s"):(0,d.g)(L,"CREDENTIALS_SSO_LEGACY","u"),L},$=(e={})=>async({callerClientConfig:s}={})=>{e.logger?.debug("@aws-sdk/credential-provider-sso - fromSSO");const{ssoStartUrl:o,ssoAccountId:i,ssoRegion:a,ssoRoleName:c,ssoSession:l}=e,{ssoClient:f}=e,g=(0,n.Bz)({profile:e.profile??s?.profile});if(o||i||a||c||l){if(o&&i&&a&&c)return N({ssoStartUrl:o,ssoSession:l,ssoAccountId:i,ssoRegion:a,ssoRoleName:c,ssoClient:f,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,callerClientConfig:e.callerClientConfig,profile:g,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger});throw new t.C('Incomplete configuration. The fromSSO() argument hash must include "ssoStartUrl", "ssoAccountId", "ssoRegion", "ssoRoleName"',{tryNextLink:!1,logger:e.logger})}{const s=(await(0,r.Y)(e))[g];if(!s)throw new t.C(`Profile ${g} was not found.`,{logger:e.logger});if(!(w=s)||"string"!=typeof w.sso_start_url&&"string"!=typeof w.sso_account_id&&"string"!=typeof w.sso_session&&"string"!=typeof w.sso_region&&"string"!=typeof w.sso_role_name)throw new t.C(`Profile ${g} is not configured with SSO credentials.`,{logger:e.logger});if(s?.sso_session){const n=(await h(e))[s.sso_session],r=` configurations in profile ${g} and sso-session ${s.sso_session}`;if(a&&a!==n.sso_region)throw new t.C("Conflicting SSO region"+r,{tryNextLink:!1,logger:e.logger});if(o&&o!==n.sso_start_url)throw new t.C("Conflicting SSO start_url"+r,{tryNextLink:!1,logger:e.logger});s.sso_region=n.sso_region,s.sso_start_url=n.sso_start_url}const{sso_start_url:n,sso_account_id:i,sso_region:c,sso_role_name:l,sso_session:d}=((e,s)=>{const{sso_start_url:o,sso_account_id:n,sso_region:r,sso_role_name:i}=e;if(!(o&&n&&r&&i))throw new t.C(`Profile is configured with invalid SSO credentials. Required parameters "sso_account_id", "sso_region", "sso_role_name", "sso_start_url". Got ${Object.keys(e).join(", ")}\nReference: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html`,{tryNextLink:!1,logger:s});return e})(s,e.logger);return N({ssoStartUrl:n,ssoSession:d,ssoAccountId:i,ssoRegion:c,ssoRoleName:l,ssoClient:f,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,callerClientConfig:e.callerClientConfig,profile:g,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger})}var w}},1303(e,s,o){o.d(s,{C:()=>i});var t=o(9),n=o(5),r=o(69);const i=e=>{const s=(0,t.createHash)("sha1").update(e).digest("hex");return(0,n.join)((0,r.R)(),".aws","sso","cache",`${s}.json`)}},1302(e,s,o){o.d(s,{a:()=>r,v:()=>i});var t=o(31),n=o(1303);const r={},i=async e=>{if(r[e])return r[e];const s=(0,n.C)(e),o=await(0,t.readFile)(s,"utf8");return JSON.parse(o)}}};